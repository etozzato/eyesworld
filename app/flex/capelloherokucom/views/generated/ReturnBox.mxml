<?xml version="1.0" encoding="utf-8"?>
<mx:HBox xmlns:mx="http://www.adobe.com/2006/mxml" label="Resi" xmlns:rx="org.restfulx.components.rx.*" styleName="mainApp">
   <mx:Metadata>
    [Event(name="logout", type="flash.events.Event")]
  </mx:Metadata>
  <mx:Script>
  <![CDATA[
    import mx.formatters.DateFormatter;
    import org.restfulx.Rx;
    import org.restfulx.utils.RxUtils;
    import capelloherokucom.models.User;
    import capelloherokucom.models.Maker;
    import capelloherokucom.models.Model;
    import capelloherokucom.models.Warehouse;
    import capelloherokucom.models.Return;
    
    import mx.controls.Alert;
    import mx.events.CloseEvent;
    import capelloherokucom.utils.Utils;
    import org.restfulx.collections.ModelsCollection;
    
    [Bindable]
    private var panelHeight:int = Utils.panelHeight;
    
    [Bindable]
    private var ret:Return = new Return();
    
    [Bindable]
    private var current_user:User

    private function getCurrentUser():void {
      current_user = null;
      Rx.http(setCurrentUser).invoke("current_user", {  }, "GET", true);
    }
    
    private function setCurrentUser(result:User):void {
      current_user = result;
    }

    private function newOrder():void{
      ret = new Return();
    }

    private function saveReturn():void {
      ret = new Return();
      updateModelProperties();
      ret.create({onSuccess: onReturnCreate});
      Rx.models.reset(Warehouse); 
    }
    
    private function updateModelProperties():void {
      ret.returnDate = returnDateField.selectedDate;
      ret.itemsReturned = int(itemsReturned.value);
      ret.total = Number(returnTotal.value);
      ret.model = modelComboBox.selectedItem.model;
      ret.maker = modelComboBox.selectedItem.maker;
    }
    
    private function onReturnCreate():void {}

    private function deleteReturn():void{
      Alert.show("Eliminare definitivamente questo reso?", "Conferma", Alert.YES|Alert.NO, this, destroyReturn, null, Alert.YES);
    }
   
    private function destroyReturn(event:CloseEvent):void {
      if (event.detail == Alert.YES) {
          ret.destroy();
          Rx.models.reset(Warehouse); 
       }
    }

    private function onReturnSelect():void {
      ret = RxUtils.clone(returnsGrid.selectedItem) as Return;
      //update_btn.enabled = false;
    }
    
    private function formatDate(item:Object, column:DataGridColumn):String{
      var df:DateFormatter = new DateFormatter();
      df.formatString = "DD/MM/YYYY";
      var value:Object = item[column.dataField];
      return df.format(value);
    }
    
    ]]></mx:Script>
  <mx:Panel id="warehousePanel" title="Gestione Resi" width="70%" height="{panelHeight}" styleName="appPanel">
  
  <mx:DataGrid dataProvider="{Rx.models.index(Return)}" id="returnsGrid" width="100%" height="100%" fontSize="12" change="onReturnSelect()" updateComplete="getCurrentUser()">
    <mx:columns>
      <mx:DataGridColumn headerText="Fornitore" dataField="maker" width="150" />
      <mx:DataGridColumn headerText="Marchio" dataField="model" width="200" />
      <mx:DataGridColumn headerText="Resi" width="130" dataField="itemsReturned" textAlign="center" />
      <mx:DataGridColumn headerText="Data Reso" dataField="returnDate" labelFunction="formatDate" textAlign="center" />
    </mx:columns>
  </mx:DataGrid>
  
  </mx:Panel>
  <mx:Panel styleName="appPanel" width="30%" height="{panelHeight}" verticalAlign="top" title="Nuovo Reso">
    <mx:Form width="100%" height="100%" id="new_order_form" visible="true">
      <mx:FormItem width="100%" fontWeight="bold" label="Marchio:">
        <mx:ComboBox id="modelComboBox" width="100%" labelField="{Warehouse.LABEL}" data="items" dataProvider="{Rx.models.index(Warehouse)}" prompt="..." />
      </mx:FormItem>
      <mx:FormItem width="100%" fontWeight="bold" label="Magazzino:">
        <mx:Text id="required" text="{modelComboBox.selectedItem.items}" height="20" width="100" textAlign="left"/>
      </mx:FormItem>
      <mx:FormItem label="Resi:" fontWeight="bold" width="100%">
        <mx:NumericStepper id="itemsReturned" value="0" maximum="{modelComboBox.selectedItem.items}" width="135" fontWeight="normal" textAlign="right" minimum="0"/>
      </mx:FormItem>
      <mx:FormItem label="Importo:" fontWeight="bold" width="100%">
        <mx:NumericStepper id="returnTotal" maximum="{current_user.currentBudget*-1}" value="0" width="135" fontWeight="normal" textAlign="right" />
      </mx:FormItem>
      <mx:FormItem label="Data:" fontWeight="bold" width="100%">
        <mx:DateField id="returnDateField" selectedDate="{ret.returnDate}" showToday="true" formatString="DD/MM/YYYY" width="135" fontWeight="normal"/>
      </mx:FormItem>
    </mx:Form>
    <mx:ControlBar width="100%">
      <mx:Button label="Salva" width="25%" height="30"
        click="saveReturn()" id="update_btn" enabled="true"/>
      <mx:Button label="Elimina" width="25%" height="30"
        enabled="{RxUtils.canDeleteModel(ret)}"
        click="deleteReturn()" styleName="deleteBtn" />
      <mx:Button label="Uscita" width="25%" height="30"
        click="Utils.logout()"/>
    </mx:ControlBar>
  </mx:Panel>
</mx:HBox>